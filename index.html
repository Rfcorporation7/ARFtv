<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARF TV - Modern Minimalist</title>
    <!-- Tambahkan library dash.js -->
    <script src="https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Tambahkan Font Awesome untuk icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ffffff;
            --secondary: #f8f9fa;
            --accent: #007AFF;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #edf2f7;
            --bg-color: #f0f2f5;
        }

        .dark-mode {
            --primary: #1a1a1a;
            --secondary: #2d2d2d;
            --accent: #0a84ff;
            --text-main: #f2f2f7;
            --text-sub: #8e8e93;
            --border: #3a3a3c;
            --bg-color: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; color: var(--text-main); transition: background-color 0.3s, color 0.3s; overflow: hidden; }
        .app-container { width: 100%; max-width: 450px; background-color: var(--primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background-color 0.3s; }
        
        /* Video Section */
        .video-section { 
            background-color: #000; 
            width: 100%; 
            aspect-ratio: 16 / 9; 
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        #main-video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            background-color: #000;
            display: block;
        }
        
        /* Hide video controls completely */
        #main-video::-webkit-media-controls {
            display: none !important;
        }
        
        #main-video::-webkit-media-controls-enclosure {
            display: none !important;
        }
        
        #main-video::-webkit-media-controls-panel {
            display: none !important;
        }
        
        /* For Firefox */
        #main-video {
            -moz-controls: none;
        }
        
        /* Channel Name Overlay */
        .channel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
            transition: opacity 0.5s ease;
            opacity: 1;
        }
        
        .channel-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .current-channel {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .channel-logo-small {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            overflow: hidden;
        }
        
        .channel-logo-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .channel-logo-small .logo-text {
            color: white;
            font-weight: bold;
        }
        
        .channel-name-overlay {
            font-size: 14px;
            font-weight: 600;
        }
        
        .app-name-overlay {
            font-size: 16px;
            font-weight: 800;
        }
        
        .app-name-overlay span {
            color: var(--accent);
        }
        
        .live-indicator-top {
            background: #ff4757;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #youtube-frame { 
            width: 100%; 
            height: 100%; 
            border: none; 
            display: none;
        }

        /* Header */
        .header-bar { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            transition: border-color 0.3s; 
        }
        
        .logo { font-size: 20px; font-weight: 800; color: var(--text-main); }
        .logo span { color: var(--accent); }
        
        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        /* Filter Button */
        .filter-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            transition: background-color 0.2s;
            position: relative;
        }
        
        .filter-btn:hover {
            background-color: var(--secondary);
        }
        
        .filter-btn.active {
            background-color: var(--secondary);
            color: var(--accent);
        }
        
        .filter-btn .filter-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Filter Menu Overlay */
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .filter-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .filter-menu {
            background: var(--primary);
            width: 300px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .filter-overlay.active .filter-menu {
            transform: translateY(0);
            opacity: 1;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .close-filter {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-filter:hover {
            background-color: var(--secondary);
        }
        
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: var(--secondary);
        }
        
        .filter-option:hover {
            background: rgba(0, 122, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .filter-option.active {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--accent);
        }
        
        .filter-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
        }
        
        .filter-info {
            flex: 1;
        }
        
        .filter-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-main);
        }
        
        .filter-desc {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 3px;
        }
        
        .filter-check {
            color: var(--accent);
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .filter-option.active .filter-check {
            opacity: 1;
        }
        
        /* Settings Menu */
        .settings-menu { 
            position: fixed; 
            top: 0; 
            right: -300px; 
            width: 280px; 
            height: 100vh; 
            background-color: var(--primary); 
            z-index: 1000; 
            padding: 20px; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .settings-menu.active {
            right: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .close-settings {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-settings:hover {
            background-color: var(--secondary);
        }
        
        .settings-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quality-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid var(--border);
        }
        
        .quality-option:hover {
            background-color: var(--secondary);
        }
        
        .quality-option.active {
            background-color: rgba(0, 122, 255, 0.1);
            border-color: var(--accent);
        }
        
        .quality-info {
            flex: 1;
        }
        
        .quality-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
        }
        
        .quality-desc {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 2px;
        }
        
        .quality-check {
            color: var(--accent);
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .quality-option.active .quality-check {
            opacity: 1;
        }
        
        .theme-info {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 8px;
            padding: 8px;
            background-color: var(--secondary);
            border-radius: 6px;
            text-align: center;
        }
        
        /* Channel List */
        .channel-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }
        
        .channel-item { 
            display: flex; 
            align-items: center; 
            padding: 12px; 
            margin-bottom: 8px;
            border-radius: 12px; 
            cursor: pointer; 
            transition: 0.2s; 
            border: 1px solid transparent;
            background-color: var(--primary);
        }
        
        .channel-item:hover { 
            background-color: var(--secondary); 
        }
        
        .channel-item.active { 
            background-color: rgba(0, 122, 255, 0.1); 
            border-color: rgba(0, 122, 255, 0.3); 
        }
        
        .channel-logo { 
            width: 45px; 
            height: 45px; 
            border-radius: 10px; 
            margin-right: 12px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 10px; 
            font-weight: bold; 
            text-align: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .channel-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .channel-logo .logo-text {
            color: white;
            font-weight: bold;
        }
        
        .channel-info { 
            flex: 1; 
        }
        
        .channel-name { 
            font-weight: 700; 
            font-size: 14px; 
            color: var(--text-main); 
        }
        
        .channel-desc { 
            font-size: 11px; 
            color: var(--text-sub); 
        }
        
        .status-live { 
            font-size: 9px; 
            font-weight: 800; 
            padding: 4px 8px; 
            border-radius: 6px; 
            background: #ffe5e5; 
            color: #ff4757; 
        }

        /* Source Selector */
        .source-selector { 
            display: flex; 
            gap: 5px; 
            margin-top: 5px; 
        }
        
        .source-btn { 
            font-size: 9px; 
            padding: 3px 8px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: var(--primary); 
            cursor: pointer; 
            color: var(--text-sub);
        }
        
        .source-btn.active { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent);
        }

        .footer { 
            padding: 15px; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid var(--border); 
            transition: border-color 0.3s; 
        }
        
        .btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 13px; 
        }
        
        .btn-saweria { 
            background: var(--accent); 
            color: white; 
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            transition: background-color 0.2s;
        }
        
        .settings-btn:hover {
            background-color: var(--secondary);
        }

        ::-webkit-scrollbar { 
            width: 4px; 
        }
        
        ::-webkit-scrollbar-thumb { 
            background: #dfe6e9; 
            border-radius: 10px; 
        }
        
        .dark-mode ::-webkit-scrollbar-thumb { 
            background: #444; 
        }
        
        /* Overlay untuk klik luar settings */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .settings-overlay.active {
            display: block;
        }
        
        /* Loading Indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Format Badge */
        .format-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            z-index: 5;
            display: none;
        }
        
        /* Streaming Tidak Tersedia Message */
        .stream-unavailable {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 30, 0.95) 100%);
            color: white;
            display: none;
            z-index: 8;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
        }
        
        .stream-unavailable-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ff6b6b;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .stream-unavailable h3 {
            margin-bottom: 15px;
            font-size: 22px;
            color: #ff6b6b;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }
        
        .stream-unavailable p {
            font-size: 14px;
            color: #ddd;
            line-height: 1.6;
            max-width: 350px;
            margin-bottom: 25px;
        }
        
        .try-other-channel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .try-other-channel:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Bottom Controls tanpa tombol fullscreen */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            z-index: 11;
            transition: opacity 0.5s ease;
            opacity: 1;
        }
        
        .bottom-controls.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Animasi untuk exit dialog */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Auto-hide controls */
        .channel-overlay.auto-hide,
        .bottom-controls.auto-hide {
            opacity: 0;
            pointer-events: none;
        }
        
        /* YouTube Container */
        .youtube-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* YouTube Error Message */
        .youtube-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 15;
            display: none;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Filter Menu Overlay -->
    <div class="filter-overlay" id="filterOverlay">
        <div class="filter-menu">
            <div class="filter-header">
                <div class="filter-title">Filter Channel</div>
                <button class="close-filter" id="closeFilter">√ó</button>
            </div>
            <div class="filter-options">
                <div class="filter-option active" data-filter="all">
                    <div class="filter-icon">
                        <i class="fas fa-tv"></i>
                    </div>
                    <div class="filter-info">
                        <div class="filter-name">Semua Channel</div>
                        <div class="filter-desc">Tampilkan semua channel</div>
                    </div>
                    <div class="filter-check">‚úì</div>
                </div>
                <div class="filter-option" data-filter="indonesia">
                    <div class="filter-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="filter-info">
                        <div class="filter-name">TV Indonesia</div>
                        <div class="filter-desc">Channel TV nasional & lokal</div>
                    </div>
                    <div class="filter-check">‚úì</div>
                </div>
                <div class="filter-option" data-filter="event">
                    <div class="filter-icon">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <div class="filter-info">
                        <div class="filter-name">Event Olahraga</div>
                        <div class="filter-desc">Live pertandingan olahraga</div>
                    </div>
                    <div class="filter-check">‚úì</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Menu -->
    <div class="settings-menu" id="settingsMenu">
        <div class="settings-header">
            <div class="settings-title">Pengaturan</div>
            <button class="close-settings" id="closeSettings">√ó</button>
        </div>
        
        <div class="settings-section">
            <div class="section-title">Kualitas Streaming</div>
            <div class="quality-option active" data-quality="auto">
                <div class="quality-info">
                    <div class="quality-name">Otomatis</div>
                    <div class="quality-desc">Menyesuaikan dengan koneksi Anda</div>
                </div>
                <div class="quality-check">‚úì</div>
            </div>
            <div class="quality-option" data-quality="low">
                <div class="quality-info">
                    <div class="quality-name">Rendah (Hemat Kuota)</div>
                    <div class="quality-desc">240p - 360p</div>
                </div>
                <div class="quality-check">‚úì</div>
            </div>
            <div class="quality-option" data-quality="medium">
                <div class="quality-info">
                    <div class="quality-name">Sedang</div>
                    <div class="quality-desc">480p - 720p</div>
                </div>
                <div class="quality-check">‚úì</div>
            </div>
            <div class="quality-option" data-quality="high">
                <div class="quality-info">
                    <div class="quality-name">Tinggi</div>
                    <div class="quality-desc">720p - 1080p</div>
                </div>
                <div class="quality-check">‚úì</div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="section-title">Tampilan</div>
            <div class="theme-info" id="themeInfo">
                Mode otomatis mengikuti waktu lokal: <span id="currentTimeDisplay"></span>
            </div>
        </div>
    </div>
    
    <!-- Overlay untuk klik luar settings -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    
    <!-- Hidden audio untuk trigger autoplay -->
    <audio id="autoplay-trigger" muted autoplay loop></audio>
    
    <div class="video-section" id="videoSection">
        <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
        </div>
        
        <!-- Streaming Tidak Tersedia Message -->
        <div class="stream-unavailable" id="streamUnavailable">
            <div class="stream-unavailable-icon">üì°</div>
            <h3>LIVE STREAMING BELUM TERSEDIA</h3>
            <p>Siaran untuk channel ini sedang tidak aktif atau terjadi gangguan sinyal.</p>
            <p>Coba pilih channel lain atau gunakan sumber streaming alternatif.</p>
            <button class="try-other-channel" id="tryOtherChannel">Coba Channel Lain</button>
        </div>
        
        <!-- Format Badge -->
        <div class="format-badge" id="formatBadge">HLS</div>
        
        <!-- Channel Name Overlay -->
        <div class="channel-overlay" id="channelOverlay">
            <div class="current-channel">
                <div class="channel-logo-small" id="currentChannelLogo"></div>
                <div class="channel-name-overlay" id="currentChannelName"></div>
                <div class="live-indicator-top">
                    <div class="live-dot"></div>
                    LIVE
                </div>
            </div>
            <div class="app-name-overlay">ARF<span>tv</span></div>
        </div>
        
        <!-- Bottom Controls -->
        <div class="bottom-controls" id="bottomControls">
            <!-- Tombol fullscreen telah dihapus -->
        </div>
        
        <!-- YouTube Error -->
        <div class="youtube-error" id="youtubeError">
            <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h3>YouTube Tidak Dapat Dimainkan</h3>
            <p>Mungkin video tidak tersedia atau terjadi pembatasan.</p>
            <p>Silakan pilih sumber streaming alternatif.</p>
        </div>
        
        <!-- Video element -->
        <video id="main-video" playsinline autoplay></video>
        <iframe id="youtube-frame" 
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
        </iframe>
    </div>

    <div class="header-bar">
        <div class="logo">ARF<span>tv</span></div>
        <div class="header-controls">
            <!-- Tombol filter -->
            <button class="filter-btn" id="filterBtn" title="Filter Channel">
                <i class="fas fa-filter"></i>
                <div class="filter-badge" id="filterBadge" style="display: none;">1</div>
            </button>
            <!-- Tombol settings -->
            <button class="settings-btn" id="settingsBtn" title="Pengaturan">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <div class="channel-list" id="list-container"></div>

    <div class="footer">
        <button class="btn btn-saweria" id="support-btn">
            <i class="fas fa-coffee"></i> Dukung Server
        </button>
    </div>
</div>

<script>
    // ========== KONFIGURASI CHANNEL ==========
    const channels = [
        { 
            name: "RCTI", 
            desc: "MNC Group", 
            m3u8: "https://allcutv.rctiplus.id/rcti2023.m3u8", 
            youtube: "VFaJpC6JLK4",
            color: "#ffffff",
            logo: "https://i.ibb.co/1ft50ybJ/8-20260104-010417-0007.png",
            category: "indonesia"
        },
        { 
            name: "MNCTV", 
            desc: "MNC Group", 
            m3u8: "https://allcutv.rctiplus.id/mnctv2023.m3u8", 
            youtube: "YZmy_kqSd3w",
            color: "#ffffff",
            logo: "https://i.ibb.co/1tWLxmHH/5-20260104-010416-0004.png",
            category: "indonesia"
        },
        { 
            name: "Nusantara TV", 
            desc: "MNC Group", 
            m3u8: "https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8", 
            youtube: "9G6T8ZNT-XA",
            color: "#ffffff",
            logo: "https://i.ibb.co.com/jvDxBR9v/20260104-051301-0000.png",
            category: "indonesia"
        },
        { 
            name: "INEWS", 
            desc: "Berita", 
            m3u8: "https://allcutv.rctiplus.id/inews2023.m3u8", 
            youtube: "9G6T8ZNT-XA",
            color: "#ffffff",
            logo: "https://i.ibb.co.com/gMZCWzmg/20260104-051120-0000.png",
            category: "indonesia"
        },
        { 
            name: "TRANS TV", 
            desc: "Hiburan", 
            m3u8: "https://d3lrdr11debmyn.cloudfront.net/ce0d357c-66ba-45cb-83f7-59846db3b948/manifest.m3u8", 
            youtube: "UoO7m7tqG_I",
            color: "#ffffff",
            logo: "https://i.ibb.co/0ygbQtmW/1-20260104-010416-0000.png",
            category: "indonesia"
        },
        { 
            name: "TRANS 7", 
            desc: "Hiburan", 
            m3u8: "https://d3lrdr11debmyn.cloudfront.net/05b78dd3-7d18-467e-b3ed-4f2f916e5ca7/manifest.mpd", 
            youtube: "g54wbPDKl3I",
            color: "#ffffff",
            logo: "https://i.ibb.co/212vVZr5/12-20260104-010417-0011.png",
            category: "indonesia"
        },
        { 
            name: "METRO TV", 
            desc: "Berita", 
            m3u8: "https://op-group1-swiftservehd-1.dens.tv/h/h12/02.m3u8", 
            youtube: "AUE5iHINUIw",
            color: "#ffffff",
            logo: "https://i.ibb.co/FbGxbPpH/3-20260104-010416-0002.png",
            category: "indonesia"
        },
        { 
            name: "SCTV", 
            desc: "Nasional", 
            m3u8: "https://cdn10jtedge.indihometv.com/atm/DASH/sctv/manifest.mpd", 
            youtube: "vmBYU7iqe_w",
            color: "#ffffff",
            logo: "https://i.ibb.co/bR5vXmV9/10-20260104-010417-0009.png",
            category: "indonesia"
        },
        { 
            name: "INDOSIAR", 
            desc: "Nasional", 
            m3u8: "https://cdn10jtedge.indihometv.com/atm/DASH/indosiar/indosiar-avc1_2500000=7-3277707030000000.mpd", 
            youtube: "A4vJ9qhP6P0",
            color: "#ffffff",
            logo: "https://i.ibb.co/bj1LmQWr/9-20260104-010417-0008.png",
            category: "indonesia"
        },
        { 
            name: "MDTV", 
            desc: "Masa Kini", 
            m3u8: "https://wahyu1ptv.pages.dev/MDTV-HD.m3u8", 
            youtube: "NTohx15sGtQ",
            color: "#ffffff",
            logo: "https://i.ibb.co.com/Kc23Th6k/20260104-050748-0000.png",
            category: "indonesia"
        },
        { 
            name: "RTV", 
            desc: "Rajawali Tv", 
            m3u8: "https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8", 
            youtube: "NTohx15sGtQ",
            color: "#ffffff",
            logo: "https://i.ibb.co.com/RkHTHY2J/20260104-060039-0000.png",
            category: "indonesia"
        },        
        { 
            name: "KOMPAS TV", 
            desc: "Berita", 
            m3u8: "https://cdn10jtedge.indihometv.com/atm/DASH/KOMPAS_TV/manifest.mpd", 
            youtube: "DOOrIxw5xOw",
            color: "#ffffff",
            logo: "https://i.ibb.co/S7BtZLHd/6-20260104-010416-0005.png",
            category: "indonesia"
        },
        { 
            name: "TVRI", 
            desc: "Nasional", 
            m3u8: "https://ott-balancer.tvri.go.id/live/eds/Nasional/hls/Nasional.m3u8", 
            youtube: "4jx5GqeU7AU",
            color: "#ffffff",
            logo: "https://i.ibb.co/MDmj0pYN/2-20260104-010416-0001.png",
            category: "indonesia"
        },
        { 
            name: "TV ONE", 
            desc: "Berita", 
            m3u8: "https://cdn10jtedge.indihometv.com/atm/DASH/tvone/manifest.mpd", 
            youtube: "yNKvkPJl-tg",
            color: "#ffffff",
            logo: "https://i.ibb.co/4ktSrNL/7-20260104-010416-0006.png",
            category: "indonesia"
        },
        { 
            name: "AFC Cup U-23", 
            desc: "Jepang vs Korea", 
            m3u8: "https://tfsm4gr5domt1gc41hctogezdep3pptwzc3jtf3a8r531cp1gh5djq310.100ycdn.com/live1.pro2cdnlive.com/live/channel15/playlist.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/q3zx0nBV/AFC-U-23-Asian-Cup-logo.jpg",
            category: "event"
        },
        { 
            name: "Bundesliga", 
            desc: "RB Leipzig vs Bayern Munchen", 
            m3u8: "https://tfsm4gr5domt1gc41hctogezdep3pptwzc3jtf3a8r531cp1gh5djq310.100ycdn.com/live1.pro2cdnlive.com/live/channel16/playlist.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/QvHBNtq8/Bundesliga-Logo-2010.png",
            category: "event"
        },
        { 
            name: "Serie A", 
            desc: "Bologna vs Fiorentina", 
            m3u8: "https://live.golivenow71.com/1f0132f062a823b2d16e22b7fc0b775d/1768786414622/gmpmb95/gmpmb95@720p.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/9m97Jmcb/Polish-20260104-001033195.png",
            category: "event"
        },
        { 
            name: "La LIGA", 
            desc: "Getafe vs Valencia FC", 
            m3u8: "https://tfsm4gr5domt1gc41hctogezdep3pptwzc3jtf3a8r531cp1gh5djq310.100ycdn.com/live1.pro2cdnlive.com/live/channel8/playlist.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/LDBtdNtJ/La-Liga-logo-2023-svg.png",
            category: "event"
        },
        { 
            name: "EPL", 
            desc: "Wolfes vs Newcastle", 
            m3u8: "https://tfsm4gr5domt1gc41hctogezdep3pptwzc3jtf3a8r531cp1gh5djq310.100ycdn.com/live1.pro2cdnlive.com/live/channel6/playlist.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/n8grzttD/Polish-20260103-234200981.png",
            category: "event"
        },            
        { 
            name: "C A F", 
            desc: "Senegal vs Sudan", 
            m3u8: "https://cxyznt2-cf.didjhfyu8yg.sbs/auth=197b00493f3d7ce5cb6409206680b70469cb54282d8dbc0dd2862c6e1175fe7b1ce2d1e521844c85221fb0ef8bff66e1937ec8087d8e4c3b500ce8e8b652f6e8026d627b5d5fb251655950c24ea21de466b1bf1c349ecb42162c41311a0f7a2c7d087793b21ac4593c00abd47197ae690e2d9f5a55014bbe7df3c25b4448e40306dbcfdd18e17a728dafbce78cd8ec1d7f03f0b6854079b454c15e63597e87dbe78029119037b9dbcf7ec2642acb9bb3ba6b70505abcd4c8adea9dbf8a427e6c581f26639e3ad80adbb6cd38b0e0b4be&cid=LDfmbWiWTuxkbtC8C3fxT260103&_v=2&_r=yLhL8x&_vis=64dcd172f89000ad44bbadc81e82c3bb0abc026d0dcf9f676f13ffccc2a3e5c9&_vvs=e488c7b20c6b2f25b0ecd82c0394e8009c5b79f5dbf69607d2b872703053d817/transcode/c395057_480p.m3u8", 
            youtube: "FvxkiZgyBHo",
            color: "#ffffff",
            logo: "https://i.ibb.co/HDZkLsmj/1767461134287.png",
            category: "event"
        },
        { 
            name: "YOUTUBE",
            desc: "KHATAMAN Ke-XII PP ASSUNNIYYAH ASSALAFIYYAH PUTRI", 
            m3u8: "https://manifest.googlevideo.com/api/manifest/hls_variant/expire/1768692551/ei/58ZradORFNOY4t4P1o-JwQM/ip/160.19.19.5/id/6uNdX5p9_qU.2/source/yt_live_broadcast/requiressl/yes/xpc/EgVo2aDSNQ%3D%3D/tx/51539830/txs/51539830%2C51539831/hfr/1/playlist_duration/30/manifest_duration/30/maudio/1/bui/AW-iu_rHT15xL8WycoiJwBOV5RBNSQgK4bwe2uM8cqgZcLm_F1K03CYl_prv4ktQKd4aXEhe59RkIpKS/spc/q5xjPHTwX_vCU4hcFJM4EkRADkvzrAeXVMZ45VoWIyaBChcIajvIGDg/vprv/1/go/1/ns/OVzonXWGxoSxtEMwimdvc4QR/rqh/5/pacing/0/nvgoi/1/ncsapi/1/keepalive/yes/fexp/51331020%2C51552689%2C51565115%2C51565682%2C51580968/dover/11/n/wq6iWiBxrJOIJTT7YHl/itag/0/playlist_type/DVR/sparams/expire%2Cei%2Cip%2Cid%2Csource%2Crequiressl%2Cxpc%2Ctx%2Ctxs%2Chfr%2Cplaylist_duration%2Cmanifest_duration%2Cmaudio%2Cbui%2Cspc%2Cvprv%2Cgo%2Cns%2Crqh%2Citag%2Cplaylist_type/sig/AJfQdSswRQIgPFn5w24H-N_qQQp5hUkDZzhp0TzcnDdx6FzmCmejzOcCIQCwUY896ATYjorVzf4ZBO1F769W2W5dr6KMh9ayk9zYkg%3D%3D/file/index.m3u8", 
            youtube: "p8A4qHfOaco",
            color: "#ffffff",
            logo: "https://i.ibb.co/wrKmKcTz/20260111-091008-0000.png",
            category: "indonesia"
        },
    ];

    // Backup logo jika gambar utama gagal load
    const backupLogos = {
        "AL-BAQOROH LIRBOYO": "ALB",
        "RCTI": "RCTI",
        "MNCTV": "MNC",
        "Nusantara TV": "NTV",
        "INEWS": "iNews",
        "TRANS TV": "TransTV",
        "TRANS 7": "Trans7",
        "METRO TV": "Metro",
        "SCTV": "SCTV",
        "INDOSIAR": "Indosiar",
        "MDTV": "MDTV",
        "KOMPAS TV": "Kompas",
        "TVRI": "TVRI",
        "TV ONE": "TVOne",
        "EPL": "EPL",
        "Serie A": "Serie A",
        "C A F": "CAF",
        "Bundesliga": "BUN",
        "La LIGA": "LaLiga",
        "YOUTUBE": "YT"
    };

    // ========== DEKLARASI VARIABEL GLOBAL ==========
    let hls = null;
    let dashPlayer = null;
    let currentSourceType = 'm3u8';
    let currentChannel = null;
    let currentQuality = 'auto';
    let isSwitchingChannel = false;
    let retryCount = 0;
    const MAX_RETRY = 5;
    let autoRestartInterval = null;
    let bufferMonitorInterval = null;
    let networkRetryTimer = null;
    let autoHideTimer = null;
    let controlsVisible = true;
    let backButtonPressed = false;
    let isPageClosing = false;
    let currentFilter = 'all';
    let filterMenuOpen = false;

    // ========== FUNGSI STOP STREAMING ==========
    function stopAllStreaming() {
        console.log("Menghentikan semua streaming...");
        
        // Hentikan semua streaming dan bersihkan resource
        if (hls) {
            hls.destroy();
            hls = null;
        }
        
        if (dashPlayer) {
            dashPlayer.destroy();
            dashPlayer = null;
        }
        
        // Hentikan video
        const video = document.getElementById('main-video');
        if (video) {
            video.pause();
            video.src = '';
            video.load();
        }
        
        // Hentikan YouTube
        const youtubeFrame = document.getElementById('youtube-frame');
        if (youtubeFrame) {
            youtubeFrame.src = '';
        }
        
        // Hentikan semua interval dan timer
        if (autoRestartInterval) clearInterval(autoRestartInterval);
        if (bufferMonitorInterval) clearInterval(bufferMonitorInterval);
        if (networkRetryTimer) clearTimeout(networkRetryTimer);
        if (autoHideTimer) clearTimeout(autoHideTimer);
    }

    // Fungsi untuk mendeteksi dan menghentikan streaming saat halaman ditutup/tidak aktif
    function setupStreamingCleanup() {
        // Deteksi ketika halaman akan ditutup
        window.addEventListener('beforeunload', function(e) {
            isPageClosing = true;
            stopAllStreaming();
            console.log("Halaman akan ditutup, streaming dihentikan");
        });
        
        // Deteksi ketika tab/window tidak aktif (hidden)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log("Halaman tidak aktif, menghentikan streaming");
                stopAllStreaming();
            } else {
                console.log("Halaman aktif kembali");
                // Saat halaman aktif kembali, refresh dan mulai ulang
                if (currentChannel && !isPageClosing) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                }
            }
        });
        
        // Deteksi ketika aplikasi pindah ke background (untuk PWA/mobile)
        if (typeof document.hidden !== "undefined") {
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log("Aplikasi di background, menghentikan streaming");
                    stopAllStreaming();
                }
            });
        }
        
        // Deteksi saat perangkat masuk mode sleep/standby
        window.addEventListener('blur', function() {
            console.log("Window kehilangan fokus, menghentikan streaming");
            stopAllStreaming();
        });
        
        // Untuk iOS: deteksi saat aplikasi pindah ke background
        document.addEventListener('webkitvisibilitychange', function() {
            if (document.webkitHidden) {
                console.log("iOS: Aplikasi di background, menghentikan streaming");
                stopAllStreaming();
            }
        });
    }

    // ========== FUNGSI FILTER CHANNEL ==========
    function updateChannelFilter(filter) {
        currentFilter = filter;
        localStorage.setItem('channelFilter', filter);
        
        // Update active option di filter menu
        document.querySelectorAll('.filter-option').forEach(option => {
            option.classList.remove('active');
            if (option.dataset.filter === filter) {
                option.classList.add('active');
            }
        });
        
        // Update filter badge
        updateFilterBadge();
        
        // Tutup filter menu
        closeFilterMenu();
        
        // Render ulang channel list dengan filter
        renderChannels(filter);
        
        // Simpan filter terakhir
        localStorage.setItem('lastFilter', filter);
        
        console.log("Filter diubah ke:", filter);
    }

    // Update filter badge
    function updateFilterBadge() {
        const filterBadge = document.getElementById('filterBadge');
        const filterBtn = document.getElementById('filterBtn');
        
        if (currentFilter !== 'all') {
            let badgeText = '';
            if (currentFilter === 'indonesia') badgeText = 'ID';
            else if (currentFilter === 'event') badgeText = 'EV';
            
            filterBadge.textContent = badgeText;
            filterBadge.style.display = 'flex';
            filterBtn.classList.add('active');
        } else {
            filterBadge.style.display = 'none';
            filterBtn.classList.remove('active');
        }
    }

    // Buka filter menu
    function openFilterMenu() {
        const filterOverlay = document.getElementById('filterOverlay');
        filterOverlay.classList.add('active');
        filterMenuOpen = true;
        
        // Nonaktifkan scroll body
        document.body.style.overflow = 'hidden';
    }

    // Tutup filter menu
    function closeFilterMenu() {
        const filterOverlay = document.getElementById('filterOverlay');
        filterOverlay.classList.remove('active');
        filterMenuOpen = false;
        
        // Aktifkan kembali scroll body
        document.body.style.overflow = '';
    }

    // ========== FUNGSI AUTO-HIDE CONTROLS ==========
    function showControls() {
        const channelOverlay = document.getElementById('channelOverlay');
        const bottomControls = document.getElementById('bottomControls');
        
        channelOverlay.classList.remove('hidden');
        bottomControls.classList.remove('hidden');
        controlsVisible = true;
        
        // Clear timer sebelumnya
        if (autoHideTimer) {
            clearTimeout(autoHideTimer);
        }
        
        // Set timer untuk auto-hide setelah 3 detik
        autoHideTimer = setTimeout(() => {
            hideControls();
        }, 3000);
    }
    
    function hideControls() {
        const channelOverlay = document.getElementById('channelOverlay');
        const bottomControls = document.getElementById('bottomControls');
        
        channelOverlay.classList.add('hidden');
        bottomControls.classList.add('hidden');
        controlsVisible = false;
    }
    
    function toggleControls() {
        if (controlsVisible) {
            hideControls();
        } else {
            showControls();
        }
    }

    // Fungsi untuk update waktu dan mode tema
    function updateTimeAndTheme() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        if (currentTimeDisplay) {
            currentTimeDisplay.textContent = `${hours}:${minutes}`;
        }
        
        if (hours >= 18 || hours < 6) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }

    // Fungsi untuk menerapkan pengaturan kualitas
    function applyQualitySettings(quality) {
        currentQuality = quality;
        localStorage.setItem('videoQuality', quality);
    }

    // Fungsi untuk deteksi tipe stream
    function detectStreamType(url) {
        if (!url) return 'unknown';
        
        if (url.includes('.m3u8')) {
            return 'hls';
        } else if (url.includes('.mpd')) {
            return 'dash';
        } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
            return 'youtube';
        } else {
            return 'direct';
        }
    }

    // ========== PERBAIKAN FUNGSI YOUTUBE YANG LEBIH BAIK ==========
    function playYouTube(videoId) {
        if (!videoId) {
            console.log("No YouTube video ID available");
            showStreamUnavailable();
            return false;
        }
        
        const youtubeFrame = document.getElementById('youtube-frame');
        const video = document.getElementById('main-video');
        const formatBadge = document.getElementById('formatBadge');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const youtubeError = document.getElementById('youtubeError');
        
        // Sembunyikan pesan error
        if (youtubeError) {
            youtubeError.style.display = 'none';
        }
        
        // Hentikan video element lain
        if (video) {
            video.pause();
            video.style.display = 'none';
        }
        
        // Hentikan streaming lain
        if (hls) {
            hls.destroy();
            hls = null;
        }
        if (dashPlayer) {
            dashPlayer.destroy();
            dashPlayer = null;
        }
        
        // Pastikan YouTube frame kosong terlebih dahulu
        youtubeFrame.src = '';
        youtubeFrame.style.display = 'none';
        
        // Tunggu sebentar untuk reset
        setTimeout(() => {
            // Parameter untuk embed YouTube yang benar
            // Menggunakan parameter yang lebih sederhana untuk compatibility yang lebih baik
            const params = new URLSearchParams({
                'autoplay': '1',
                'mute': '0',
                'playsinline': '1',
                'controls': '0',
                'rel': '0',
                'modestbranding': '1',
                'disablekb': '1',
                'fs': '0', // Nonaktifkan tombol fullscreen di YouTube player
                'enablejsapi': '1',
                'origin': window.location.origin,
                'widget_referrer': window.location.origin,
                'iv_load_policy': '3' // Nonaktifkan anotasi
            });
            
            // Coba beberapa metode embed yang berbeda untuk kompatibilitas
            const embedUrls = [
                `https://www.youtube-nocookie.com/embed/${videoId}?${params.toString()}`,
                `https://www.youtube.com/embed/${videoId}?${params.toString()}`,
                `https://www.youtube.com/embed/live_stream?channel=${videoId}`
            ];
            
            console.log("Loading YouTube embed with videoId:", videoId);
            
            // Coba URL pertama
            youtubeFrame.src = embedUrls[0];
            youtubeFrame.style.display = 'block';
            
            if (formatBadge) {
                formatBadge.textContent = "YouTube";
                formatBadge.style.display = 'block';
            }
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            hideStreamUnavailable();
            
            // Tambahkan event listeners untuk YouTube frame
            youtubeFrame.onload = function() {
                console.log("YouTube frame loaded successfully");
                isSwitchingChannel = false;
                
                // Coba untuk memulai video melalui postMessage
                try {
                    setTimeout(() => {
                        youtubeFrame.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                    }, 1000);
                } catch (e) {
                    console.log("YouTube postMessage error:", e);
                }
                
                // Mulai timer auto-hide setelah video mulai
                showControls();
            };
            
            youtubeFrame.onerror = function() {
                console.log("YouTube frame loading error, trying alternative URL...");
                
                // Coba URL alternatif
                setTimeout(() => {
                    youtubeFrame.src = embedUrls[1];
                }, 1000);
            };
            
            // Set timeout untuk deteksi error
            setTimeout(() => {
                if (isSwitchingChannel) {
                    console.log("YouTube timeout, showing error");
                    if (youtubeError) {
                        youtubeError.style.display = 'block';
                    }
                    isSwitchingChannel = false;
                }
            }, 5000);
            
            return true;
        }, 100);
    }

    // Fungsi untuk memutar stream DASH
    function playDashStream(url) {
        const video = document.getElementById('main-video');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        if (!dashjs || !dashjs.supportsMediaSource()) {
            console.log("DASH not supported in this browser");
            showStreamUnavailable();
            return false;
        }
        
        if (dashPlayer) {
            dashPlayer.destroy();
            dashPlayer = null;
        }
        
        try {
            dashPlayer = dashjs.MediaPlayer().create();
            
            dashPlayer.updateSettings({
                streaming: {
                    delay: {
                        liveDelay: 3,
                        liveDelayFragmentCount: 3
                    },
                    abr: {
                        autoSwitchBitrate: {
                            video: true,
                            audio: true
                        },
                        limitBitrateByPortal: true,
                        useDefaultABRRules: true,
                        initialBitrate: {
                            video: 500000
                        }
                    },
                    cache: {
                        cacheLoadThresholdForVideo: 15,
                        cacheLoadThresholdForAudio: 15
                    },
                    buffer: {
                        bufferTimeAtTopQuality: 30,
                        bufferTimeAtTopQualityLongForm: 30,
                        stableBufferTime: 20,
                        longFormContentDurationThreshold: 600
                    }
                }
            });
            
            if (currentQuality === 'low') {
                dashPlayer.updateSettings({
                    streaming: {
                        abr: {
                            maxBitrate: {
                                video: 700000,
                                audio: 96000
                            }
                        }
                    }
                });
            } else if (currentQuality === 'medium') {
                dashPlayer.updateSettings({
                    streaming: {
                        abr: {
                            maxBitrate: {
                                video: 2000000,
                                audio: 128000
                            }
                        }
                    }
                });
            }
            
            dashPlayer.initialize(video, url, true);
            
            dashPlayer.on(dashjs.MediaPlayer.events.PLAYBACK_PLAYING, () => {
                console.log("DASH playback started");
                isSwitchingChannel = false;
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                hideStreamUnavailable();
                retryCount = 0;
                
                // Mulai timer auto-hide setelah video mulai
                showControls();
            });
            
            dashPlayer.on(dashjs.MediaPlayer.events.ERROR, (e) => {
                console.log("DASH error:", e);
                if (!isSwitchingChannel) {
                    handleStreamError(currentChannel, currentSourceType);
                }
            });
            
            return true;
        } catch (error) {
            console.log("DASH player error:", error);
            showStreamUnavailable();
            return false;
        }
    }

    // Fungsi untuk memutar stream HLS
    function playHlsStream(url) {
        const video = document.getElementById('main-video');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const formatBadge = document.getElementById('formatBadge');
        
        if (Hls && Hls.isSupported()) {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 30,
                autoStartLoad: true,
                startPosition: -1,
                debug: false,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                maxBufferSize: 60 * 1000 * 1000,
                maxBufferHole: 0.5,
                liveSyncDurationCount: 3,
                liveMaxLatencyDurationCount: 10,
                enableCEA708Captions: true,
                manifestLoadingTimeOut: 10000,
                levelLoadingTimeOut: 10000,
                fragLoadingTimeOut: 20000,
                manifestLoadingMaxRetry: 3,
                levelLoadingMaxRetry: 3,
                fragLoadingMaxRetry: 5,
                fragLoadingRetryDelay: 1000,
                fragLoadingMaxRetryTimeout: 60000
            });
            
            hls.loadSource(url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(e => {
                    console.log("HLS initial play error:", e);
                    if (!isSwitchingChannel) {
                        handleStreamError(currentChannel, currentSourceType);
                    }
                });
                
                if (currentQuality === 'low' && hls.levels && hls.levels.length > 0) {
                    let lowestBitrate = Infinity;
                    let lowestLevel = 0;
                    
                    hls.levels.forEach((level, index) => {
                        if (level.bitrate < lowestBitrate) {
                            lowestBitrate = level.bitrate;
                            lowestLevel = index;
                        }
                    });
                    
                    hls.currentLevel = lowestLevel;
                }
                
                isSwitchingChannel = false;
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                hideStreamUnavailable();
                retryCount = 0;
                
                // Mulai timer auto-hide setelah video mulai
                showControls();
            });
            
            hls.on(Hls.Events.ERROR, (event, data) => {
                console.log("HLS Error:", data.type, data.details);
                
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log("Network error, trying to recover...");
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log("Media error, recovering...");
                            hls.recoverMediaError();
                            break;
                        default:
                            console.log("Fatal error, cannot recover");
                            if (!isSwitchingChannel) {
                                handleStreamError(currentChannel, currentSourceType);
                            }
                            break;
                    }
                }
            });
            
            if (formatBadge) {
                formatBadge.textContent = "HLS";
                formatBadge.style.display = 'block';
            }
            
            return true;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.load();
            
            video.play().catch(e => {
                console.log("Safari play error:", e);
                if (!isSwitchingChannel) {
                    handleStreamError(currentChannel, currentSourceType);
                }
            });
            
            isSwitchingChannel = false;
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            hideStreamUnavailable();
            retryCount = 0;
            
            if (formatBadge) {
                formatBadge.textContent = "HLS";
                formatBadge.style.display = 'block';
            }
            
            // Mulai timer auto-hide setelah video mulai
            showControls();
            return true;
        }
        
        showStreamUnavailable();
        return false;
    }

    // Fungsi untuk membuat elemen logo dengan fallback
    function createLogoElement(channel, small = false) {
        const container = document.createElement('div');
        container.className = small ? 'channel-logo-small' : 'channel-logo';
        container.style.backgroundColor = channel.color;
        
        const img = document.createElement('img');
        img.src = channel.logo;
        img.alt = channel.name;
        img.onerror = function() {
            this.style.display = 'none';
            const text = document.createElement('div');
            text.className = 'logo-text';
            text.textContent = backupLogos[channel.name] || channel.name.substring(0,3);
            container.appendChild(text);
        };
        
        container.appendChild(img);
        return container;
    }

    // Inisialisasi autoplay dengan sekali klik
    function initializeAutoplay() {
        const clickHandler = () => {
            const autoplayTrigger = document.getElementById('autoplay-trigger');
            const video = document.getElementById('main-video');
            
            if (autoplayTrigger) {
                autoplayTrigger.play().then(() => {
                    console.log("Autoplay unlocked");
                }).catch(console.log);
            }
            
            if (video && video.muted) {
                video.muted = false;
                video.volume = 1;
            }
            
            document.removeEventListener('click', clickHandler);
        };
        
        document.addEventListener('click', clickHandler);
        
        const autoplayTrigger = document.getElementById('autoplay-trigger');
        if (autoplayTrigger) {
            autoplayTrigger.play().catch(() => {
                console.log("Will unlock on first click");
            });
        }
    }

    // Fungsi untuk menampilkan overlay channel
    function showChannelOverlay(channel) {
        const currentChannelName = document.getElementById('currentChannelName');
        const currentChannelLogo = document.getElementById('currentChannelLogo');
        
        if (currentChannelName) {
            currentChannelName.textContent = channel.name;
        }
        
        if (currentChannelLogo) {
            currentChannelLogo.innerHTML = '';
            const logoContainer = createLogoElement(channel, true);
            currentChannelLogo.appendChild(logoContainer.firstChild);
        }
        
        showControls();
    }

    // Fungsi untuk restart video jika berhenti
    function restartVideoIfStopped() {
        if (!currentChannel || isSwitchingChannel) return;
        
        if (currentSourceType === 'youtube') return;
        
        const video = document.getElementById('main-video');
        if (!video) return;
        
        if ((video.paused && !video.ended) || video.ended) {
            console.log("Video stopped, attempting to restart...");
            
            if (video.buffered.length > 0) {
                const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                const currentTime = video.currentTime;
                
                if (bufferedEnd - currentTime > 1) {
                    video.play().catch(e => {
                        console.log("Restart failed:", e);
                        if (retryCount < 2) {
                            showStreamUnavailable();
                        }
                    });
                } else {
                    console.log("Buffer empty, reloading stream...");
                    showStreamUnavailable();
                }
            } else {
                console.log("No buffer available, reloading stream...");
                showStreamUnavailable();
            }
        }
    }

    // Fungsi untuk monitor buffer health
    function monitorBufferHealth() {
        if (!currentChannel || isSwitchingChannel || currentSourceType === 'youtube') return;
        
        const video = document.getElementById('main-video');
        if (!video) return;
        
        if (video.buffered.length > 0) {
            const bufferedEnd = video.buffered.end(video.buffered.length - 1);
            const currentTime = video.currentTime;
            const bufferAhead = bufferedEnd - currentTime;
            
            if (bufferAhead < 2 && bufferAhead > 0) {
                console.log(`Low buffer: ${bufferAhead.toFixed(1)}s ahead`);
                
                if (hls && hls.levels && hls.levels.length > 1 && currentQuality === 'auto') {
                    const currentLevel = hls.currentLevel;
                    if (currentLevel > 0) {
                        hls.currentLevel = currentLevel - 1;
                        console.log("Temporarily lowering quality for buffer recovery");
                    }
                }
            }
        }
    }

    // Fungsi untuk handle error streaming
    function handleStreamError(channel, sourceType) {
        if (isSwitchingChannel) return;
        
        retryCount++;
        console.log(`Stream error. Retry ${retryCount}/${MAX_RETRY}`);
        
        if (retryCount <= MAX_RETRY) {
            if (networkRetryTimer) {
                clearTimeout(networkRetryTimer);
            }
            
            const delay = Math.min(1000 * Math.pow(2, retryCount - 1), 10000);
            console.log(`Retrying in ${delay}ms...`);
            
            networkRetryTimer = setTimeout(() => {
                if (!isSwitchingChannel && currentChannel === channel) {
                    playStream(channel, sourceType);
                }
            }, delay);
        } else {
            console.log("Max retries reached, showing unavailable message");
            retryCount = 0;
            showStreamUnavailable();
            isSwitchingChannel = false;
        }
    }

    // ========== STREAMING TIDAK TERSEDIA ==========
    function showStreamUnavailable() {
        console.log("Menampilkan pesan streaming tidak tersedia");
        const streamUnavailable = document.getElementById('streamUnavailable');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const video = document.getElementById('main-video');
        const youtubeFrame = document.getElementById('youtube-frame');
        const youtubeError = document.getElementById('youtubeError');
        
        if (streamUnavailable) {
            streamUnavailable.style.display = 'flex';
        }
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (video) {
            video.style.display = 'none';
        }
        
        if (youtubeFrame) {
            youtubeFrame.style.display = 'none';
        }
        
        if (youtubeError) {
            youtubeError.style.display = 'none';
        }
        
        if (hls) {
            hls.destroy();
            hls = null;
        }
        if (dashPlayer) {
            dashPlayer.destroy();
            dashPlayer = null;
        }
    }
    
    function hideStreamUnavailable() {
        const streamUnavailable = document.getElementById('streamUnavailable');
        if (streamUnavailable) {
            streamUnavailable.style.display = 'none';
        }
    }

    // Fungsi untuk memutar stream
    function playStream(channel, sourceType = 'm3u8') {
        if (isSwitchingChannel) return;
        
        isSwitchingChannel = true;
        retryCount = 0;
        
        if (networkRetryTimer) {
            clearTimeout(networkRetryTimer);
            networkRetryTimer = null;
        }
        
        currentChannel = channel;
        currentSourceType = sourceType;
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }
        
        hideStreamUnavailable();
        showChannelOverlay(channel);
        
        const video = document.getElementById('main-video');
        if (video) {
            video.volume = 1;
            video.muted = false;
        }
        
        // Sembunyikan pesan error YouTube
        const youtubeError = document.getElementById('youtubeError');
        if (youtubeError) {
            youtubeError.style.display = 'none';
        }
        
        if (sourceType === 'youtube') {
            if (!channel.youtube) {
                console.log("No YouTube source available");
                showStreamUnavailable();
                isSwitchingChannel = false;
                return;
            }
            
            // Pastikan YouTube frame siap
            const youtubeFrame = document.getElementById('youtube-frame');
            youtubeFrame.style.display = 'none';
            
            // Tunggu sedikit untuk memastikan frame sudah diatur
            setTimeout(() => {
                const success = playYouTube(channel.youtube);
                if (success) {
                    isSwitchingChannel = false;
                } else {
                    showStreamUnavailable();
                    isSwitchingChannel = false;
                }
            }, 100);
        } else {
            const youtubeFrame = document.getElementById('youtube-frame');
            const video = document.getElementById('main-video');
            const formatBadge = document.getElementById('formatBadge');
            
            if (youtubeFrame) {
                youtubeFrame.src = '';
                youtubeFrame.style.display = 'none';
            }
            
            if (video) {
                video.style.display = 'block';
            }
            
            const streamUrl = channel.m3u8;
            const streamType = detectStreamType(streamUrl);
            
            console.log(`Playing ${channel.name} - Type: ${streamType} - Quality: ${currentQuality}`);
            
            if (formatBadge) {
                if (streamType === 'hls') {
                    formatBadge.textContent = "HLS";
                    formatBadge.style.display = 'block';
                } else if (streamType === 'dash') {
                    formatBadge.textContent = "DASH";
                    formatBadge.style.display = 'block';
                } else {
                    formatBadge.style.display = 'none';
                }
            }
            
            if (hls) {
                hls.destroy();
                hls = null;
            }
            if (dashPlayer) {
                dashPlayer.destroy();
                dashPlayer = null;
            }
            
            let success = false;
            if (streamType === 'hls') {
                success = playHlsStream(streamUrl);
            } else if (streamType === 'dash') {
                success = playDashStream(streamUrl);
            } else {
                if (video) {
                    video.src = streamUrl;
                    video.load();
                    
                    video.play().catch(e => {
                        console.log("Direct play error:", e);
                        showStreamUnavailable();
                        isSwitchingChannel = false;
                    });
                }
                
                isSwitchingChannel = false;
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                hideStreamUnavailable();
                success = true;
                
                if (formatBadge) {
                    formatBadge.textContent = "DIRECT";
                    formatBadge.style.display = 'block';
                }
                
                // Mulai timer auto-hide setelah video mulai
                showControls();
            }
            
            if (!success) {
                showStreamUnavailable();
                isSwitchingChannel = false;
            }
        }
    }

    // Render channels dengan filter
    function renderChannels(filter = 'all') {
        const listContainer = document.getElementById('list-container');
        if (!listContainer) return;
        
        // Kosongkan container
        listContainer.innerHTML = '';
        
        // Filter channels berdasarkan kategori
        let filteredChannels = channels;
        if (filter !== 'all') {
            filteredChannels = channels.filter(ch => ch.category === filter);
        }
        
        // Jika tidak ada channel setelah difilter
        if (filteredChannels.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.style.textAlign = 'center';
            emptyMessage.style.padding = '40px 20px';
            emptyMessage.style.color = 'var(--text-sub)';
            emptyMessage.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 15px;">üì∫</div>
                <div style="font-weight: 600; margin-bottom: 10px;">Tidak ada channel</div>
                <div style="font-size: 12px;">Tidak ada channel yang tersedia dalam kategori ini</div>
            `;
            listContainer.appendChild(emptyMessage);
            return;
        }
        
        filteredChannels.forEach((ch, index) => {
            const item = document.createElement('div');
            item.className = 'channel-item';
            
            const mainStreamType = detectStreamType(ch.m3u8);
            const streamTypeLabel = mainStreamType === 'dash' ? 'mpd' : 'm3u8';
            
            item.innerHTML = `
                <div class="channel-logo" style="background-color: ${ch.color}"></div>
                <div class="channel-info">
                    <div class="channel-name">${ch.name}</div>
                    <div class="channel-desc">${ch.desc}</div>
                    <div class="source-selector">
                        <button class="source-btn m3u8-btn active" data-channel="${index}" data-type="m3u8">${streamTypeLabel}</button>
                        <button class="source-btn youtube-btn" data-channel="${index}" data-type="youtube">YouTube</button>
                    </div>
                </div>
                <span class="status-live" style="display:none">LIVE</span>
            `;
            
            const logoContainer = item.querySelector('.channel-logo');
            const logoElement = createLogoElement(ch);
            logoContainer.appendChild(logoElement.firstChild);

            item.addEventListener('click', function(e) {
                if (e.target.classList.contains('source-btn')) return;
                if (isSwitchingChannel) return;
                
                document.querySelectorAll('.channel-item').forEach(el => {
                    el.classList.remove('active');
                    const liveBadge = el.querySelector('.status-live');
                    if (liveBadge) liveBadge.style.display = 'none';
                });
                
                item.classList.add('active');
                const liveBadge = item.querySelector('.status-live');
                if (liveBadge) liveBadge.style.display = 'block';
                
                const activeBtn = item.querySelector('.source-btn.active');
                const sourceType = activeBtn ? activeBtn.dataset.type : 'm3u8';
                playStream(ch, sourceType);
            });
            
            listContainer.appendChild(item);

            const m3u8Btn = item.querySelector('.m3u8-btn');
            const youtubeBtn = item.querySelector('.youtube-btn');

            if (m3u8Btn) {
                m3u8Btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (isSwitchingChannel) return;
                    
                    if (this.classList.contains('active')) return;
                    
                    item.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.channel-item').forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.querySelector('.m3u8-btn').classList.remove('active');
                            otherItem.querySelector('.youtube-btn').classList.remove('active');
                            otherItem.querySelector('.m3u8-btn').classList.add('active');
                        }
                    });
                    
                    if (item.classList.contains('active')) {
                        playStream(ch, 'm3u8');
                    }
                });
            }

            if (youtubeBtn) {
                youtubeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (isSwitchingChannel) return;
                    
                    if (this.classList.contains('active')) return;
                    
                    item.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.channel-item').forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.querySelector('.m3u8-btn').classList.remove('active');
                            otherItem.querySelector('.youtube-btn').classList.remove('active');
                            otherItem.querySelector('.m3u8-btn').classList.add('active');
                        }
                    });
                    
                    if (item.classList.contains('active')) {
                        playStream(ch, 'youtube');
                    }
                });
            }
        });
    }

    // ========== INISIALISASI APLIKASI ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Setup streaming cleanup (untuk otomatis stop saat halaman ditutup/tidak aktif)
        setupStreamingCleanup();
        
        // Inisialisasi autoplay
        initializeAutoplay();
        
        // Load pengaturan kualitas
        const savedQuality = localStorage.getItem('videoQuality');
        if (savedQuality) {
            currentQuality = savedQuality;
            document.querySelectorAll('.quality-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.quality === savedQuality) {
                    opt.classList.add('active');
                }
            });
        }
        
        // Load filter terakhir
        const savedFilter = localStorage.getItem('lastFilter');
        if (savedFilter) {
            currentFilter = savedFilter;
        } else {
            currentFilter = 'all';
        }
        
        // Update filter badge
        updateFilterBadge();
        
        // Setup tema
        updateTimeAndTheme();
        setInterval(updateTimeAndTheme, 60000);
        
        // Setup interval untuk monitor dan restart otomatis
        autoRestartInterval = setInterval(restartVideoIfStopped, 3000);
        bufferMonitorInterval = setInterval(monitorBufferHealth, 5000);
        
        // Setup event listeners untuk filter
        const filterBtn = document.getElementById('filterBtn');
        const closeFilter = document.getElementById('closeFilter');
        const filterOverlay = document.getElementById('filterOverlay');
        
        if (filterBtn) {
            filterBtn.addEventListener('click', function() {
                openFilterMenu();
            });
        }
        
        if (closeFilter) {
            closeFilter.addEventListener('click', function() {
                closeFilterMenu();
            });
        }
        
        if (filterOverlay) {
            filterOverlay.addEventListener('click', function(e) {
                if (e.target === filterOverlay) {
                    closeFilterMenu();
                }
            });
        }
        
        // Setup filter options
        document.querySelectorAll('.filter-option').forEach(option => {
            option.addEventListener('click', function() {
                const filter = this.dataset.filter;
                updateChannelFilter(filter);
            });
        });
        
        // Set active filter option
        document.querySelectorAll('.filter-option').forEach(option => {
            option.classList.remove('active');
            if (option.dataset.filter === currentFilter) {
                option.classList.add('active');
            }
        });
        
        // Render channels dengan filter saat ini
        renderChannels(currentFilter);
        
        // AUTO PLAY CHANNEL PERTAMA SAAT APLIKASI DIBUKA
        if (channels.length > 0) {
            // Cari channel pertama berdasarkan filter yang aktif
            let firstChannel = channels[0];
            if (currentFilter !== 'all') {
                const filtered = channels.filter(ch => ch.category === currentFilter);
                if (filtered.length > 0) {
                    firstChannel = filtered[0];
                }
            }
            
            setTimeout(() => {
                const channelItems = document.querySelectorAll('.channel-item');
                if (channelItems.length > 0) {
                    channelItems[0].classList.add('active');
                    const liveBadge = channelItems[0].querySelector('.status-live');
                    if (liveBadge) liveBadge.style.display = 'block';
                    
                    showChannelOverlay(firstChannel);
                    // Tunggu sebentar sebelum memulai streaming
                    setTimeout(() => {
                        playStream(firstChannel, 'm3u8');
                    }, 500);
                }
            }, 100);
        }
        
        // ========== EVENT LISTENERS ==========
        
        // Event listeners untuk video
        const video = document.getElementById('main-video');
        if (video) {
            video.addEventListener('playing', () => {
                console.log("Video is playing normally");
                retryCount = 0;
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                hideStreamUnavailable();
            });
            
            video.addEventListener('waiting', () => {
                console.log("Video waiting for data...");
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }
            });
            
            video.addEventListener('stalled', () => {
                console.log("Media playback stalled");
                if (!isSwitchingChannel && currentSourceType !== 'youtube') {
                    setTimeout(() => {
                        if (video.paused || video.ended) {
                            console.log("Attempting to recover from stall");
                            video.play().catch(e => {
                                console.log("Stall recovery failed:", e);
                                if (!isSwitchingChannel) {
                                    showStreamUnavailable();
                                }
                            });
                        }
                    }, 2000);
                }
            });
            
            video.addEventListener('error', (e) => {
                console.log("Video element error:", e);
                if (currentChannel && !isSwitchingChannel && currentSourceType !== 'youtube') {
                    handleStreamError(currentChannel, currentSourceType);
                }
            });
        }
        
        // YouTube frame error handling
        const youtubeFrame = document.getElementById('youtube-frame');
        if (youtubeFrame) {
            youtubeFrame.addEventListener('load', () => {
                console.log("YouTube frame loaded successfully");
                youtubeFrame.style.display = 'block';
                isSwitchingChannel = false;
                
                // Coba inject script untuk otomatis play video
                try {
                    setTimeout(() => {
                        youtubeFrame.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                    }, 1000);
                } catch (e) {
                    console.log("YouTube postMessage error:", e);
                }
                
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                hideStreamUnavailable();
                retryCount = 0;
                
                // Mulai timer auto-hide setelah video mulai
                showControls();
            });
            
            youtubeFrame.addEventListener('error', () => {
                console.log("YouTube frame error");
                const youtubeError = document.getElementById('youtubeError');
                if (youtubeError) {
                    youtubeError.style.display = 'block';
                }
                isSwitchingChannel = false;
            });
        }
        
        // Support button
        const supportBtn = document.getElementById('support-btn');
        if (supportBtn) {
            supportBtn.addEventListener('click', function() {
                window.open('https://saweria.co');
            });
        }

        // Settings functions
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');
        const closeSettings = document.getElementById('closeSettings');
        const settingsOverlay = document.getElementById('settingsOverlay');
        
        if (settingsBtn && settingsMenu) {
            settingsBtn.addEventListener('click', function() {
                // Tutup filter menu jika terbuka
                if (filterMenuOpen) {
                    closeFilterMenu();
                }
                
                settingsMenu.classList.add('active');
                if (settingsOverlay) {
                    settingsOverlay.classList.add('active');
                }
            });
        }
        
        if (closeSettings && settingsMenu && settingsOverlay) {
            closeSettings.addEventListener('click', function() {
                settingsMenu.classList.remove('active');
                settingsOverlay.classList.remove('active');
            });
        }

        if (settingsOverlay && settingsMenu) {
            settingsOverlay.addEventListener('click', function() {
                settingsMenu.classList.remove('active');
                settingsOverlay.classList.remove('active');
            });
        }

        // Setup quality options
        document.querySelectorAll('.quality-option').forEach(option => {
            option.addEventListener('click', function() {
                const quality = this.dataset.quality;
                
                document.querySelectorAll('.quality-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                
                applyQualitySettings(quality);
                
                if (currentChannel && currentSourceType === 'm3u8') {
                    playStream(currentChannel, currentSourceType);
                }
            });
        });

        // Tombol "Coba Channel Lain"
        const tryOtherChannelBtn = document.getElementById('tryOtherChannel');
        if (tryOtherChannelBtn) {
            tryOtherChannelBtn.addEventListener('click', function() {
                hideStreamUnavailable();
                if (currentChannel) {
                    // Dapatkan channel yang sesuai dengan filter aktif
                    let filteredChannels = channels;
                    if (currentFilter !== 'all') {
                        filteredChannels = channels.filter(ch => ch.category === currentFilter);
                    }
                    
                    const currentIndex = filteredChannels.findIndex(ch => ch === currentChannel);
                    const nextIndex = (currentIndex + 1) % filteredChannels.length;
                    const nextChannel = filteredChannels[nextIndex];
                    
                    document.querySelectorAll('.channel-item').forEach(el => {
                        el.classList.remove('active');
                        const liveBadge = el.querySelector('.status-live');
                        if (liveBadge) liveBadge.style.display = 'none';
                    });
                    
                    const channelItems = document.querySelectorAll('.channel-item');
                    if (channelItems[nextIndex]) {
                        channelItems[nextIndex].classList.add('active');
                        const liveBadge = channelItems[nextIndex].querySelector('.status-live');
                        if (liveBadge) liveBadge.style.display = 'block';
                    }
                    
                    playStream(nextChannel, currentSourceType);
                }
            });
        }

        // Klik pada video untuk toggle controls
        const videoSection = document.getElementById('videoSection');
        if (videoSection) {
            videoSection.addEventListener('click', function(e) {
                toggleControls();
            });
        }

        // ========== HANDLE TOMBOL KEMBALI ==========
        
        // Untuk menangani history state
        window.history.pushState({page: "arf_tv"}, "", window.location.href);
        
        // Deteksi tombol kembali hardware
        window.addEventListener('popstate', function(event) {
            console.log("Tombol kembali ditekan (popstate)");
            
            if (!backButtonPressed) {
                backButtonPressed = true;
                event.preventDefault();
                
                // Hentikan streaming dan refresh halaman
                stopAllStreaming();
                setTimeout(() => {
                    location.reload();
                }, 100);
                
                // Push state lagi untuk mencegah navigasi
                window.history.pushState({page: "arf_tv"}, "", window.location.href);
            }
        });

        // Handle tombol Escape (untuk desktop)
        document.addEventListener('keydown', function(e) {
            // Deteksi tombol Escape
            if (e.key === 'Escape') {
                // Cek jika tidak sedang berada di input field
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    
                    // Tutup filter menu jika terbuka
                    if (filterMenuOpen) {
                        closeFilterMenu();
                        return;
                    }
                    
                    // Hentikan streaming dan refresh halaman
                    stopAllStreaming();
                    setTimeout(() => {
                        location.reload();
                    }, 100);
                }
            }
            
            // Panah kiri/kanan untuk channel navigation
            if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
                e.preventDefault();
                // Dapatkan channel yang sesuai dengan filter aktif
                let filteredChannels = channels;
                if (currentFilter !== 'all') {
                    filteredChannels = channels.filter(ch => ch.category === currentFilter);
                }
                
                const currentIndex = filteredChannels.findIndex(ch => ch === currentChannel);
                if (currentIndex !== -1 && filteredChannels.length > 0) {
                    let newIndex;
                    if (e.code === 'ArrowRight') {
                        newIndex = (currentIndex + 1) % filteredChannels.length;
                    } else {
                        newIndex = (currentIndex - 1 + filteredChannels.length) % filteredChannels.length;
                    }
                    
                    const newChannel = filteredChannels[newIndex];
                    const originalIndex = channels.findIndex(ch => ch === newChannel);
                    const channelItems = document.querySelectorAll('.channel-item');
                    
                    if (channelItems[newIndex]) {
                        document.querySelectorAll('.channel-item').forEach(el => {
                            el.classList.remove('active');
                            const liveBadge = el.querySelector('.status-live');
                            if (liveBadge) liveBadge.style.display = 'none';
                        });
                        
                        channelItems[newIndex].classList.add('active');
                        const liveBadge = channelItems[newIndex].querySelector('.status-live');
                        if (liveBadge) liveBadge.style.display = 'block';
                        
                        playStream(newChannel, currentSourceType);
                    }
                }
            }
            
            // Tombol F untuk membuka filter
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                openFilterMenu();
            }
        });

        // Network online/offline detection
        window.addEventListener('online', () => {
            console.log("Network connection restored");
            if (currentChannel && !isSwitchingChannel) {
                const video = document.getElementById('main-video');
                if (video && (video.paused || video.ended) && currentSourceType !== 'youtube') {
                    console.log("Attempting to restart stream after reconnection");
                    setTimeout(() => {
                        playStream(currentChannel, currentSourceType);
                    }, 1000);
                }
            }
        });
        
        // Double tap untuk toggle controls pada mobile
        let lastTap = 0;
        if (videoSection) {
            videoSection.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    toggleControls();
                }
                
                lastTap = currentTime;
            });
        }
        
        // Mouse movement detection untuk show controls
        if (videoSection) {
            videoSection.addEventListener('mousemove', function() {
                showControls();
            });
        }
        
        // Cleanup intervals on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRestartInterval) clearInterval(autoRestartInterval);
            if (bufferMonitorInterval) clearInterval(bufferMonitorInterval);
            if (networkRetryTimer) clearTimeout(networkRetryTimer);
            if (autoHideTimer) clearTimeout(autoHideTimer);
            if (hls) hls.destroy();
            if (dashPlayer) dashPlayer.destroy();
        });
        
        console.log("Aplikasi ARF TV telah dimuat dengan sukses!");
        console.log("Filter aktif: " + currentFilter);
        console.log("Streaming akan otomatis berhenti ketika aplikasi ditutup/tidak aktif");
        console.log("Aplikasi akan refresh otomatis saat dibuka kembali");
    });
</script>
</body>
</html>
